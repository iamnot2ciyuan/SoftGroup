2025-11-26 23:40:00,143 - INFO - Config:
model:
  channels: 32
  num_blocks: 6        # [关键修复] 从 7 改为 6，减少一层下采样，避免BatchNorm错误
  semantic_classes: 3   # 0=low_vegetation, 1=terrain, 2=tree
  instance_classes: 1   # 全部树归为1类实例
  sem2ins_classes: [2]  # 对语义类别2（tree）做实例分割
  semantic_only: False
  semantic_weight: [1.0, 1.0, 1.0]
  ignore_label: -100
  with_coords: True

  grouping_cfg:
    with_pyramid: False
    pyramid_base_size: 20
    with_octree: True
    # [核心修复] 降低分数组阈值，让更多低置信度的点也能参与聚类
    score_thr: 0.2    # 从0.5降低到0.2，让更多点参与聚类
    # [核心修复] 增大聚类半径：从 12 (1.2m) 增大到 20 (2.0m)
    # 20 体素 * 0.1m/体素 = 2.0m 物理半径
    # 鉴于模型的 Offset 误差仍在 2.7 米左右，2 米的搜索半径有很大机会捕获到飘散的树冠点
    # 这是打破当前"零正样本"僵局的强力手段
    radius: 20          # 20个体素 = 2.0米 (10cm体素 * 20 = 2.0米)
    mean_active: 300   # [终极修复] 验证集OOM的终极杀手锏：从2000降到300（ScanNet默认值）
    class_numpoint_mean: [-1., -1., -1.]
    # [建议] 保持较低的点数阈值，确保即使圈到的点不多也能形成 Proposal
    npoint_thr: 20     # 保持较低值，确保即使圈到的点不多也能形成 Proposal
    ignore_classes: [0, 1]  # 只忽略low_vegetation和terrain，对tree(2)做聚类

  instance_voxel_cfg:
    scale: 10            # 10cm体素，更适合森林
    spatial_shape: 512

  train_cfg:
    lvl_fusion: True
    max_proposal_num: 1000
    # [核心修复] 降低正样本门槛：从 0.5 降低到 0.25
    # 树木形状不规则，且点云稀疏，很难达到 0.5 的重叠度
    # 只要生成的框和 GT 有 25% 的重叠就算正样本，先让 num_pos > 0 再说
    pos_iou_thr: 0.25
    match_low_quality: True
    # [核心修复] 降低最小正样本阈值：从 0.3 降低到 0.25
    min_pos_thr: 0.25

  test_cfg:
    x4_split: False
    cls_score_thr: 0.05
    mask_score_thr: 0.5
    min_npoint: 50
    eval_tasks: ['semantic']  # [最终绕过 OOM] 暂时移除 'instance' 评估，只跑 Semantic 评估
  fixed_modules: []

data:
  train:
    type: 'forinstance'
    data_root: 'dataset/forinstance'
    prefix: 'train'
    suffix: '.las'
    training: True
    repeat: 4            # [修复] 降低Batch Size后，增加Repeat次数保证训练数据量
    voxel_cfg:
      scale: 10            # 10cm 体素，更适合森林
      # [核心修复] 新格式: [Z, XY] -> Z轴 256 (25.6米), XY轴 160 (16米)
      # 这是一个固定的取景框，不会再动态缩小了
      spatial_shape: [256, 160]
      # 允许框内有更多点，防止采样导致的稀疏
      max_npoint: 100000   # [修复] 增大到100k，充分利用显存
      # 只要框到了 1000 个点以上就算有效批次
      min_npoint: 1000     # [核心修复] 从 500 提高到 1000，过滤掉太稀疏的样本
  test:
    type: 'forinstance'
    data_root: 'dataset/forinstance'
    prefix: 'val'
    suffix: '.las'
    training: False
    voxel_cfg:
      scale: 10
      # [核心修复] 新格式: [Z, XY] -> Z轴 128 (12.8米), XY轴 128 (12.8米)
      spatial_shape: [128, 128]  # 固定窗口大小，不再动态缩小
      max_npoint: 30000    # [永久 OOM 修复] 相应降低点数限制
      min_npoint: 1000     # [修复] 降低最小点数，适配新的裁剪策略

dataloader:
  train:
    batch_size: 1        # [修复] 降到最小，避免OOM
    num_workers: 4        # [修复] 提高到4，减少Loss波动
  test:
    batch_size: 1
    num_workers: 1

optimizer:
  type: 'Adam'
  lr: 0.002

loss_weights:
  semantic_loss: 1.0
  offset_loss: 0.1
  cls_loss: 1.0
  mask_loss: 1.0
  iou_score_loss: 1.0

fp16: False
epochs: 108
step_epoch: 20
save_freq: 4
log_interval: 10

2025-11-26 23:40:00,143 - INFO - Distributed: False
2025-11-26 23:40:00,143 - INFO - Mix precision training: False
2025-11-26 23:40:06,022 - INFO - Load train dataset: 40 scans
2025-11-26 23:40:06,024 - INFO - Load test dataset: 11 scans
2025-11-26 23:40:06,026 - INFO - Training
2025-11-26 23:40:15,115 - WARNING - pt_offset_label 修正后仍然很大 (max=29.69)，可能仍有单位问题！
2025-11-26 23:40:23,212 - WARNING - pt_offset_label 修正后仍然很大 (max=35.52)，可能仍有单位问题！
2025-11-26 23:40:23,562 - WARNING - pt_offset_label 修正后仍然很大 (max=28.10)，可能仍有单位问题！
2025-11-26 23:40:25,231 - WARNING - pt_offset_label 修正后仍然很大 (max=26.47)，可能仍有单位问题！
2025-11-26 23:40:37,609 - WARNING - pt_offset_label 修正后仍然很大 (max=31.03)，可能仍有单位问题！
2025-11-26 23:40:38,718 - WARNING - pt_offset_label 修正后仍然很大 (max=34.21)，可能仍有单位问题！
2025-11-26 23:40:41,417 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:40:51,516 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:40:54,777 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:40:56,629 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:40:58,106 - INFO - Epoch [1/108][10/40]  lr: 0.002, eta: 6:14:05, mem: 1498, data_time: 0.00, iter_time: 0.65, semantic_loss: 0.8774, offset_loss: 4.3407, cls_loss: 0.3868, mask_loss: 0.0000, iou_score_loss: 0.0000, num_pos: 0.0000, num_neg: 5.0000, loss: 5.6050
2025-11-26 23:40:58,783 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:41:03,598 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:41:05,313 - WARNING - pt_offset_label 修正后仍然很大 (max=28.78)，可能仍有单位问题！
2025-11-26 23:41:08,651 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:41:09,255 - WARNING - pt_offset_label 修正后仍然很大 (max=29.80)，可能仍有单位问题！
2025-11-26 23:41:14,670 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:41:19,778 - WARNING - pt_offset_label 修正后仍然很大 (max=35.47)，可能仍有单位问题！
2025-11-26 23:41:22,142 - WARNING - pt_offset_label 修正后仍然很大 (max=32.08)，可能仍有单位问题！
2025-11-26 23:41:28,945 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:41:31,372 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:41:33,436 - INFO - Epoch [1/108][20/40]  lr: 0.002, eta: 5:13:12, mem: 1621, data_time: 0.00, iter_time: 0.64, semantic_loss: 0.5988, offset_loss: 4.2438, cls_loss: 0.0469, mask_loss: 0.0000, iou_score_loss: 0.0000, num_pos: 0.0000, num_neg: 9.0000, loss: 4.8895
2025-11-26 23:41:37,116 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:41:41,044 - WARNING - pt_offset_label 修正后仍然很大 (max=30.24)，可能仍有单位问题！
2025-11-26 23:41:44,825 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:41:47,167 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:41:51,162 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:41:54,443 - WARNING - pt_offset_label 修正后仍然很大 (max=27.83)，可能仍有单位问题！
2025-11-26 23:41:54,665 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:41:55,909 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:41:56,152 - WARNING - pt_offset_label 修正后仍然很大 (max=22.82)，可能仍有单位问题！
2025-11-26 23:42:12,620 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:42:17,414 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:42:18,203 - INFO - Epoch [1/108][30/40]  lr: 0.002, eta: 5:15:00, mem: 1621, data_time: 19.83, iter_time: 20.52, semantic_loss: 0.1981, offset_loss: 1.9444, cls_loss: 0.0124, mask_loss: 0.0000, iou_score_loss: 0.0000, num_pos: 0.0000, num_neg: 38.0000, loss: 2.1549
2025-11-26 23:42:19,017 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:42:19,262 - WARNING - pt_offset_label 修正后仍然很大 (max=25.18)，可能仍有单位问题！
2025-11-26 23:42:22,452 - WARNING - pt_offset_label 修正后仍然很大 (max=35.60)，可能仍有单位问题！
2025-11-26 23:42:24,586 - WARNING - pt_offset_label 修正后仍然很大 (max=29.67)，可能仍有单位问题！
2025-11-26 23:42:26,503 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
2025-11-26 23:42:33,943 - WARNING - pt_offset_label 修正后仍然很大 (max=30.76)，可能仍有单位问题！
2025-11-26 23:42:40,715 - WARNING - pt_offset_label 修正后仍然很大 (max=26.00)，可能仍有单位问题！
