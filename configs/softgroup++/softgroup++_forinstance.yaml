model:
  channels: 32
  num_blocks: 6        # [关键修复] 从 7 改为 6，减少一层下采样，避免BatchNorm错误
  semantic_classes: 3   # 0=low_vegetation, 1=terrain, 2=tree
  instance_classes: 1   # 全部树归为1类实例
  sem2ins_classes: [2]  # 对语义类别2（tree）做实例分割
  semantic_only: False
  semantic_weight: [1.0, 1.0, 1.0]
  ignore_label: -100
  with_coords: True

  grouping_cfg:
    with_pyramid: False
    pyramid_base_size: 20
    with_octree: True
    score_thr: 0.5    # [关键修复] 从0.2提高到0.5，大幅减少测试时生成的Proposal数量，防止OOM
    radius: 4          # [修复] 0.4米 -> 4个体素 (10cm体素 * 4 = 0.4米)
    mean_active: 300   # [终极修复] 验证集OOM的终极杀手锏：从2000降到300（ScanNet默认值）
    class_numpoint_mean: [-1., -1., -1.]
    npoint_thr: 20     # [修复] 降低阈值，从100降到20
    ignore_classes: [0, 1]  # 只忽略low_vegetation和terrain，对tree(2)做聚类

  instance_voxel_cfg:
    scale: 10            # 10cm体素，更适合森林
    spatial_shape: 512

  train_cfg:
    lvl_fusion: True
    max_proposal_num: 1000
    pos_iou_thr: 0.5
    match_low_quality: True
    min_pos_thr: 0.3

  test_cfg:
    x4_split: False
    cls_score_thr: 0.05
    mask_score_thr: 0.5
    min_npoint: 50
    eval_tasks: ['semantic']  # [最终绕过 OOM] 暂时移除 'instance' 评估，只跑 Semantic 评估
  fixed_modules: []

data:
  train:
    type: 'forinstance'
    data_root: 'dataset/forinstance'
    prefix: 'train'
    suffix: '.las'
    training: True
    repeat: 4            # [修复] 降低Batch Size后，增加Repeat次数保证训练数据量
    voxel_cfg:
      scale: 10            # 10cm 体素，更适合森林
      spatial_shape: [256, 192]  # [终极 BN 修复] 从 [256, 160] 增大到 [256, 192] (约 19.2m 高)，增加特征图的非零点密度
      max_npoint: 100000   # [修复] 增大到100k，充分利用显存
      min_npoint: 1000     # [终极 BN 修复] 从 500 提高到 1000，过滤掉太稀疏的样本
  test:
    type: 'forinstance'
    data_root: 'dataset/forinstance'
    prefix: 'val'
    suffix: '.las'
    training: False
    voxel_cfg:
      scale: 10
      spatial_shape: [128, 128]  # [永久 OOM 修复] 将空间形状缩小到最小可行窗口 (12.8m x 12.8m)
      max_npoint: 30000    # [永久 OOM 修复] 相应降低点数限制
      min_npoint: 5000     # [修复] 提高最小点数，确保数据质量

dataloader:
  train:
    batch_size: 1        # [修复] 降到最小，避免OOM
    num_workers: 4        # [修复] 提高到4，减少Loss波动
  test:
    batch_size: 1
    num_workers: 1

optimizer:
  type: 'Adam'
  lr: 0.002

loss_weights:
  semantic_loss: 1.0
  offset_loss: 0.1
  cls_loss: 1.0
  mask_loss: 1.0
  iou_score_loss: 1.0

fp16: False
epochs: 108
step_epoch: 20
save_freq: 4
log_interval: 10
